# Signature Service

Service abstraction layer for digital signature operations with mock certSIGN integration.

## Overview

The signature service provides a clean, type-safe interface for:

- ‚úÖ Certificate validation
- ‚úçÔ∏è Single document signing
- üì¶ Batch document signing (Scenario 9: 13 docs in ~30s)
- üîç Signature verification
- üìä Signature audit trail

## Usage

### Import

```typescript
import { signDocument, validateCertificate, verifySignature } from "@/lib/signature";
```

### Using the React Hook

```typescript
import { useSignature } from "@/hooks/use-signature";

function MyComponent() {
  const { sign, isLoading, error } = useSignature();

  const handleSign = async () => {
    const result = await sign({
      document_url: "https://...",
      cerere_id: "uuid-here",
      cnp: "1700101123456",
      signature_reason: "Aprobare cerere",
    });

    if (result) {
      console.log("Document signed:", result.signed_document_url);
      console.log("Transaction ID:", result.transaction_id);
    }
  };

  return (
    <button onClick={handleSign} disabled={isLoading}>
      {isLoading ? "Se semneazƒÉ..." : "SemneazƒÉ document"}
    </button>
  );
}
```

### Direct Service Usage

#### 1. Validate Certificate

```typescript
const validation = await validateCertificate("1700101123456");

if (validation.valid) {
  console.log("Certificate valid:", validation.holder_name);
  console.log("Expires in:", validation.days_until_expiry, "days");
} else {
  console.log("Certificate invalid:", validation.reason);
}
```

#### 2. Get Certificate Details

```typescript
const certificate = await getCertificate("1700101123456");

if (certificate) {
  console.log("Holder:", certificate.holder_name);
  console.log("Serial:", certificate.certificate_serial);
  console.log("Status:", certificate.status);
}
```

#### 3. Sign Single Document

```typescript
const result = await signDocument({
  document_url: "https://storage/documents/cerere-123.pdf",
  cerere_id: "550e8400-e29b-41d4-a716-446655440000",
  cnp: "1700101123456",
  signature_reason: "Aprobare cerere de autoriza»õie",
});

if (result.success) {
  console.log("Signed document:", result.signed_document_url);
  console.log("Transaction ID:", result.transaction_id);
} else {
  console.error("Signing failed:", result.error);
}
```

#### 4. Sign Batch of Documents

```typescript
const batchResult = await signDocumentsBatch({
  cnp: "1700101123456",
  batch_reason: "Aprobare lunarƒÉ cereri",
  documents: [
    {
      document_url: "https://storage/documents/cerere-1.pdf",
      cerere_id: "uuid-1",
      signature_reason: "Aprobare",
    },
    {
      document_url: "https://storage/documents/cerere-2.pdf",
      cerere_id: "uuid-2",
      signature_reason: "Aprobare",
    },
    // ... up to 13+ documents
  ],
});

if (batchResult.success) {
  console.log("Session ID:", batchResult.session_id);
  console.log("Summary:", batchResult.summary);
  // { total: 13, succeeded: 12, failed: 1, duration_ms: 28500 }

  batchResult.results?.forEach((doc) => {
    if (doc.status === "success") {
      console.log(`‚úÖ Cerere ${doc.cerere_id}: ${doc.signed_document_url}`);
    } else {
      console.log(`‚ùå Cerere ${doc.cerere_id}: ${doc.error}`);
    }
  });
}
```

#### 5. Verify Signature

```typescript
const verification = await verifySignature("MOCK-SIG-1704321234567-ABC123");

if (verification.success && verification.is_valid) {
  console.log("‚úÖ Signature valid");
  console.log("Signer:", verification.signature?.signer_name);
  console.log("Signed on:", verification.signature?.timestamp);
  console.log("Age:", verification.signature?.age_days, "days");

  if (verification.is_mock) {
    console.warn("‚ö†Ô∏è MOCK signature - not legally valid");
  }
} else {
  console.error("‚ùå Signature invalid:", verification.error);
}
```

## Types

All types are exported from `@/lib/signature`:

```typescript
import type {
  CertificateValidation,
  CertificateDetails,
  SignatureRequest,
  SignatureResult,
  BatchSignatureRequest,
  BatchSignatureResult,
  SignatureVerification,
} from "@/lib/signature";
```

## Error Handling

All service methods return results with `success` boolean:

```typescript
const result = await signDocument(request);

if (!result.success) {
  // Handle error
  console.error("Error:", result.error);
  // Show user-friendly message
  toast.error(result.error || "Eroare la semnare");
}
```

## Mock Signatures

All signatures generated by this service are **MOCK** signatures for development/PoC purposes:

- ‚ö†Ô∏è **NOT legally valid**
- üîç Clearly marked with `is_mock: true`
- üìã Visual watermark: "SEMNƒÇTURƒÇ MOCK (PoC - NU E VALIDƒÇ LEGAL)"
- üé® Orange warning banner on signed PDFs

## Integration with Cerere Workflow

Example integration in cerere approval flow:

```typescript
async function approveCerere(cerereId: string, primarCNP: string) {
  // 1. Validate certificate
  const validation = await validateCertificate(primarCNP);
  if (!validation.valid) {
    throw new Error(`Certificat invalid: ${validation.reason}`);
  }

  // 2. Get document URL from cerere
  const cerere = await getCerere(cerereId);
  const documentUrl = cerere.document_url;

  // 3. Sign document
  const signResult = await signDocument({
    document_url: documentUrl,
    cerere_id: cerereId,
    cnp: primarCNP,
    signature_reason: "Aprobare cerere",
  });

  if (!signResult.success) {
    throw new Error(`Semnare e»ôuatƒÉ: ${signResult.error}`);
  }

  // 4. Update cerere with signed document
  await updateCerere(cerereId, {
    status: "aprobata",
    signed_document_url: signResult.signed_document_url,
    signature_transaction_id: signResult.transaction_id,
  });

  // 5. Send notification to citizen
  await sendApprovalEmail(cerere, signResult.signed_document_url);
}
```

## Performance

- **Single signature**: ~2-3 seconds
- **Batch signing (13 docs)**: ~28-30 seconds (Scenario 9)
- **Verification**: <500ms (cached for 1 hour)

## API Endpoints

The service wraps these API endpoints:

- `POST /api/mock-certsign/certificates/validate` - Certificate validation
- `GET /api/mock-certsign/certificates/[cnp]` - Get certificate details
- `POST /api/mock-certsign/sign` - Sign single document
- `POST /api/mock-certsign/sign/batch` - Sign batch of documents
- `GET /api/mock-certsign/verify/[transactionId]` - Verify signature

## Database Tables

Signature operations create audit trail in:

- `signature_audit_log` - Complete audit trail for all signatures
- `batch_signature_log` - Performance metrics for batch operations
- `mock_certificates` - Certificate storage and status

## See Also

- `/api/mock-certsign/` - API endpoint implementations
- `/lib/pdf/signature-watermark.ts` - PDF watermarking utility
- `supabase/migrations/20260103004325_create_certsign_tables.sql` - Database schema
